generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// ==========================
/// ENUMS
/// ==========================

enum OrderStatus {
  pending
  processing
  ready
  completed
  canceled
}

enum PaymentStatus {
  pending
  paid
  failed
}

enum OrderSource {
  customer
  cashier
}

enum PaymentMethod {
  cash
  card
  ewallet
}

enum PaymentResultStatus {
  success
  failed
  refunded
}

enum ShiftStatus {
  open
  closed
}

enum TransactionType {
  income
  expense
}

enum DiscountType {
  percent
  fixed
}

/// ==========================
/// TABLES
/// ==========================

model BlacklistToken {
  id         Int      @id @default(autoincrement())
  token      String   @db.Text
  expired_at DateTime
  created_at DateTime @default(now())
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  users       User[]
}

model User {
  id            Int        @id @default(autoincrement())
  avatar        String?    @db.VarChar(255)
  name          String     @db.VarChar(100)
  username      String     @unique @db.VarChar(100)
  email         String     @unique @db.VarChar(100)
  password      String     @db.VarChar(255)
  birth_of_date DateTime?  @db.Date
  phone_number  String?    @db.VarChar(100)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt

  role_id       Int?
  role          Role?      @relation(fields: [role_id], references: [id], onDelete: Cascade)
  customer      Customer?
  shifts        Shift[]
  orders        Order[]    @relation("CashierOrders")

  @@index([role_id])
}

model Customer {
  id          Int        @id @default(autoincrement())
  user_id     Int        @unique
  points      Int?       @default(0)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  user        User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  carts       Cart[]
  wishlists   Wishlist[]
  orders      Order[]
  reviews     Review[]

  @@index([user_id])
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  products    Product[]
}

model Product {
  id               Int             @id @default(autoincrement())
  category_id      Int
  name             String          @db.VarChar(100)
  description      String          @db.Text
  price            Decimal         @db.Decimal(10,2)
  stock            Int             @default(0)
  image            String          @db.VarChar(255)
  created_at       DateTime        @default(now())
  updated_at       DateTime        @updatedAt

  category         Category        @relation(fields: [category_id], references: [id], onDelete: Cascade)
  order_items      OrderItem[]
  cart_items       CartItem[]
  wishlists        Wishlist[]
  reviews          Review[]
  discounts        ProductDiscount[]

  @@index([category_id])
}

model Wishlist {
  id           Int        @id @default(autoincrement())
  customer_id  Int
  product_id   Int
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt

  customer     Customer    @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  product      Product     @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([customer_id, product_id])
  @@index([customer_id])
  @@index([product_id])
}

model Cart {
  id           Int       @id @default(autoincrement())
  customer_id  Int
  total        Decimal   @default("0.00") @db.Decimal(10,2)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  customer     Customer  @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  items        CartItem[]

  @@index([customer_id])
}

model CartItem {
  id               Int       @id @default(autoincrement())
  cart_id          Int
  product_id       Int
  quantity         Int       @default(1)
  price            Decimal   @db.Decimal(10,2)
  subtotal         Decimal   @db.Decimal(10,2)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  cart             Cart      @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  product          Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([cart_id, product_id])
  @@index([cart_id])
  @@index([product_id])
}

model Order {
  id                 Int            @id @default(autoincrement())
  customer_id        Int?
  cashier_id         Int?
  order_code         String         @unique
  source             OrderSource
  total              Decimal        @db.Decimal(10,2)
  final_total        Decimal        @db.Decimal(10,2)
  status             OrderStatus    @default(pending)
  payment_status     PaymentStatus  @default(pending)
  discount_id        Int?
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt

  customer           Customer?      @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  cashier            User?          @relation("CashierOrders", fields: [cashier_id], references: [id], onDelete: Cascade)
  order_items        OrderItem[]
  payments           Payment[]
  transactions       Transaction[]
  discount           Discount?      @relation(fields: [discount_id], references: [id])

  @@index([customer_id])
  @@index([cashier_id])
  @@index([discount_id])
}

model OrderItem {
  id               Int       @id @default(autoincrement())
  order_id         Int
  product_id       Int
  quantity         Int
  price            Decimal   @db.Decimal(10,2)
  subtotal         Decimal   @db.Decimal(10,2)
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  order            Order     @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product          Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([order_id])
  @@index([product_id])
}

model Payment {
  id               Int                @id @default(autoincrement())
  order_id         Int
  method           PaymentMethod
  amount           Decimal            @db.Decimal(10,2)
  status           PaymentResultStatus
  transaction_time DateTime?
  created_at       DateTime           @default(now())
  updated_at       DateTime           @updatedAt

  order            Order              @relation(fields: [order_id], references: [id], onDelete: Cascade)
  transactions     Transaction[]

  @@index([order_id])
}

model Shift {
  id         Int        @id @default(autoincrement())
  user_id    Int
  start_time DateTime
  end_time   DateTime?
  cash_start Decimal     @default("0.00") @db.Decimal(10,2)
  cash_end   Decimal     @default("0.00") @db.Decimal(10,2)
  notes      String?     @db.Text
  status     ShiftStatus
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt

  user       User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([user_id])
}

model Transaction {
  id          Int              @id @default(autoincrement())
  shift_id    Int
  order_id    Int?
  payment_id  Int?
  type        TransactionType
  amount      Decimal          @db.Decimal(10,2)
  description String?          @db.VarChar(255)
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt

  shift       Shift            @relation(fields: [shift_id], references: [id], onDelete: Cascade)
  order       Order?           @relation(fields: [order_id], references: [id], onDelete: Cascade)
  payment     Payment?         @relation(fields: [payment_id], references: [id], onDelete: Cascade)

  @@index([shift_id])
  @@index([order_id])
  @@index([payment_id])
}

model Review {
  id          Int       @id @default(autoincrement())
  customer_id Int
  product_id  Int
  rating      Int
  comment     String?   @db.Text
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  customer    Customer  @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([customer_id])
  @@index([product_id])
}

/// ==========================
/// DISCOUNT SYSTEM (SINGLE MODEL)
/// ==========================

model Discount {
  id            Int           @id @default(autoincrement())
  name          String        @db.VarChar(100)
  description   String?       @db.Text
  type          DiscountType
  value         Decimal       @db.Decimal(10,2)
  start_date    DateTime?
  end_date      DateTime?
  is_active     Boolean       @default(true)
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt

  products      ProductDiscount[]
  orders        Order[]
}

model ProductDiscount {
  id            Int       @id @default(autoincrement())
  product_id    Int
  discount_id   Int

  product       Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  discount      Discount  @relation(fields: [discount_id], references: [id], onDelete: Cascade)

  @@index([product_id])
  @@index([discount_id])
}
